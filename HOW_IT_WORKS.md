# Market Prediction Analyzer - How It Works

## ğŸ“Š Overview

Your **Market Prediction Analyzer** is a web application that tracks and analyzes prediction markets from Manifold Markets. It shows probability changes over time using **sparkline charts** and provides AI-powered insights about market movements.

---

## ğŸ”„ Data Flow: Where Does the Data Come From?

### 1. **Live Market Data** (Primary Source)
- **API**: Manifold Markets API (`https://api.manifold.markets/v0/`)
- **Endpoints Used**:
  - `/search-markets` - Fetches current prediction markets based on your search query
  - `/market/{id}` - Gets detailed info for specific markets (probabilities, answers, etc.)
  - `/bets` - Retrieves historical betting data for backfilling

### 2. **Local Storage** (Historical Data)
- **Key**: `market_snapshots_v1`
- **Purpose**: Stores snapshots of market probabilities over time
- **Structure**: Array of snapshot objects, each containing:
  ```json
  {
    "date": "2026-01-22T06:00:00.000Z",
    "markets": [
      {
        "id": "market-123",
        "question": "Will AI surpass humans by 2030?",
        "probability": 0.65,
        "participants": 142,
        "url": "https://manifold.markets/...",
        ...
      }
    ]
  }
  ```
- **Retention**: Keeps last 120 snapshots (automatically pruned)

### 3. **Historical Backfill** (When Needed)
- If you don't have enough local history, the app automatically fetches historical probabilities from Manifold's `/bets` API
- This happens when you set a lookback period (e.g., 7 days) but don't have 7 days of local snapshots yet

---

## ğŸ“ˆ How Charts Are Generated

### **Sparkline Charts** (Mini trend graphs)

The sparklines you see on each market card are generated by the `renderSparkline()` function:

#### Process:
1. **Data Collection**: 
   - When you fetch markets, the app creates a "snapshot" with current probabilities
   - This snapshot is merged with historical snapshots from localStorage
   - `buildMarketHistory()` builds a time-series for each market

2. **Time Series Construction**:
   ```javascript
   // For each market, creates an array like:
   [
     { ts: 1737504000000, p: 0.45 },  // 7 days ago
     { ts: 1737590400000, p: 0.48 },  // 6 days ago
     { ts: 1737676800000, p: 0.52 },  // 5 days ago
     ...
     { ts: 1738108800000, p: 0.65 }   // today
   ]
   ```

3. **Chart Rendering**:
   - `getMarketTrendInfo(marketId)` retrieves the time series
   - `renderSparkline(series)` converts data points to SVG coordinates
   - Creates an SVG `<polyline>` element that connects the points
   - Normalizes values to fit in a 100x24 viewBox

4. **Visual Output**:
   ```html
   <svg class="sparkline" viewBox="0 0 100 24">
     <polyline points="0,12 25,10 50,8 75,6 100,4" />
   </svg>
   ```

### **Chart Metadata**
Each chart also shows:
- **Delta**: Change in probability (e.g., "+12 pts" = increased 12%)
- **Volatility**: 
  - "Stable" = avg swing < 2%
  - "Active" = avg swing 2-6%
  - "Choppy" = avg swing > 6%
- **Then vs Now**: Starting and ending probabilities

---

## ğŸ¯ Application Workflow

### **Step-by-Step Process**

#### 1. **Initialization** (`initialize()`)
```
User opens app
  â†“
Load saved settings (lookback days, LLM config)
  â†“
Setup event listeners
  â†“
Render category filters
  â†“
Auto-fetch markets
```

#### 2. **Fetching Markets** (`fetchMarkets()`)
```
User clicks "Fetch Markets" or enters search query
  â†“
Show loading skeletons
  â†“
Load historical snapshots from localStorage
  â†“
Fetch live markets from Manifold API
  â†“
Create current snapshot
  â†“
Merge with historical snapshots
  â†“
Save to localStorage
  â†“
Build market history (time series for each market)
  â†“
Calculate stats
  â†“
Render market cards with sparklines
  â†“
Generate AI insights (if LLM configured)
```

#### 3. **Historical Data Management**
```
loadSnapshots()
  â†“
Load from localStorage (local snapshots)
  â†“
Merge arrays and remove duplicates
  â†“
Prune old snapshots (keep last 120)
  â†“
Return cleaned snapshot array
```

#### 4. **Backfilling Missing History**
```
If lookback period > available history
  â†“
backfillHistory() - Fetch historical bets from API
  â†“
For top 24 markets:
  - Fetch last bet before target date
  - Extract probability at that time
  â†“
Create synthetic snapshot for past date
  â†“
Inject into snapshot array
```

#### 5. **Chart Generation**
```
For each market:
  â†“
getMarketTrendInfo(marketId)
  - Get time series from marketHistory Map
  - Calculate delta (change)
  - Calculate average swing (volatility)
  â†“
renderSparkline(series)
  - Normalize values to 0-24 range
  - Convert to SVG coordinates
  - Generate polyline points
  â†“
Display chart in market card
```

#### 6. **AI Insights** (Optional)
```
If LLM configured:
  â†“
generateInsights()
  â†“
Send market data to LLM API
  â†“
Parse JSON response
  â†“
Inject insights into market cards
```

---

## ğŸ—‚ï¸ Key Data Structures

### **Market Object**
```javascript
{
  id: "abc123",
  source: "manifold",
  question: "Will AI surpass humans by 2030?",
  probability: 0.65,              // Current probability (0-1)
  volume: 5420,                   // Trading volume
  participants: 142,              // Number of traders
  url: "https://manifold.markets/...",
  createdTime: 1704067200000,
  closeTime: 1767225600000,
  isResolved: false,
  tags: ["AI", "Technology"],
  liquidity: 1200,
  outcomeType: "BINARY",
  answers: []                     // For multiple choice markets
}
```

### **Snapshot Object**
```javascript
{
  date: "2026-01-22T06:00:00.000Z",
  markets: [/* array of market objects */]
}
```

### **Market History Map**
```javascript
Map {
  "market-id-1" => [
    { ts: 1737504000000, p: 0.45 },
    { ts: 1737590400000, p: 0.48 },
    ...
  ],
  "market-id-2" => [...]
}
```

---

## ğŸ¨ UI Components

### **1. Category Filters**
- 7 categories: AI, Politics, Economics, Sports, Technology, Science, Climate
- Click to filter markets by category
- Uses keyword matching on market questions

### **2. Market Cards**
- Shows current probability with color coding:
  - ğŸŸ¢ Green (>70%): High probability
  - ğŸŸ¡ Yellow (30-70%): Medium probability
  - ğŸ”´ Red (<30%): Low probability
- Displays sparkline chart if historical data available
- Shows delta and volatility metrics
- AI-generated insight at bottom

### **3. Catch-up Digest**
- **Top Movers**: Markets with biggest absolute changes
- **Top Gainers**: Markets with biggest increases
- **Top Losers**: Markets with biggest decreases
- Compares current snapshot vs snapshot from X days ago

### **4. Stats Dashboard**
- Total Markets
- Average Probability
- High Confidence (>70%)
- Trending (markets with data)

---

## âš™ï¸ Configuration

### **Lookback Period**
- Default: 7 days
- Range: 1-30 days
- Stored in: `localStorage.lookback_days`
- Controls how far back charts look

### **LLM Integration** (Optional)
- Base URL: OpenAI-compatible API endpoint
- API Key: Your authentication key
- Model: e.g., "gpt-4", "gpt-3.5-turbo"
- Used for generating market insights

---

## ğŸ”§ Technical Details

### **Snapshot Management**
- **Frequency**: Every time you fetch markets
- **Storage**: Browser localStorage (5-10MB limit)
- **Pruning**: Automatically keeps last 120 snapshots
- **Deduplication**: Merges snapshots by date

### **API Rate Limiting**
- Enrichment limited to 15 markets per fetch
- Backfill limited to 24 markets
- Prevents overwhelming Manifold API

### **Performance Optimizations**
- Debounced search (500ms delay)
- Skeleton loading states
- Async/parallel API calls
- Cached historical data

---

## ğŸ“Š Example: How a Chart is Built

Let's say you have a market "Will AI surpass humans by 2030?" and you set lookback to 7 days:

1. **Day 1**: You fetch markets â†’ Probability is 45% â†’ Saved to localStorage
2. **Day 2**: You fetch again â†’ Probability is 48% â†’ Saved
3. **Day 3**: Probability is 52%
4. **Day 7**: Probability is 65%

When you view the market on Day 7:
- `buildMarketHistory()` creates: `[{ts: Day1, p: 0.45}, {ts: Day2, p: 0.48}, ..., {ts: Day7, p: 0.65}]`
- `getMarketTrendInfo()` calculates:
  - Delta: +20 pts (65% - 45%)
  - Volatility: "Active" (moderate swings)
- `renderSparkline()` draws an upward trending line
- Card shows: "Then: 45% â†’ Now: 65%" with green sparkline

---

## ğŸš€ Summary

**Your charts come from**:
1. âœ… Live data from Manifold Markets API
2. âœ… Historical snapshots stored in your browser's localStorage
3. âœ… Automatic backfilling from Manifold's betting history API

**The application**:
- Fetches current market probabilities
- Stores them as timestamped snapshots
- Builds time-series data for each market
- Renders SVG sparkline charts
- Calculates trends and volatility
- Optionally adds AI-generated insights

**All data is stored locally** in your browser - no backend server needed! ğŸ‰
